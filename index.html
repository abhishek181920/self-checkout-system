<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCANEZY - User Dashboard</title>
    <meta name="description" content="Smart Self-Checkout System for Retail Stores">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SCANEZY">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192x192.png">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .onboarding-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
        }
        .mobile-container {
            max-width: 414px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }
        .onboarding-card {
            width: 100%;
            max-width: 420px;
            background: white;
            border-radius: 20px;
            padding: 2rem 1.5rem;
            box-shadow: 0 25px 60px rgba(79,70,229,0.35);
        }
        .onboarding-title {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .onboarding-title h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            color: #312e81;
        }
        .role-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .role-card {
            border: 2px solid #e0e7ff;
            border-radius: 16px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #f8fafc;
        }
        .role-card.active {
            border-color: #7c3aed;
            background: #f3e8ff;
            box-shadow: 0 10px 25px rgba(124,58,237,0.2);
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.35rem;
            color: #4338ca;
            font-size: 0.9rem;
        }
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 10px;
            border: 1px solid #c7d2fe;
            font-size: 1rem;
        }
        .otp-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .primary-btn {
            flex: 1;
            border: none;
            border-radius: 12px;
            padding: 0.85rem 1rem;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            cursor: pointer;
        }
        .secondary-btn {
            flex: 1;
            border: 1px solid #c7d2fe;
            border-radius: 12px;
            padding: 0.85rem 1rem;
            font-weight: 600;
            color: #4f46e5;
            background: #eef2ff;
            cursor: pointer;
        }
        .status-banner {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 10px;
            font-size: 0.9rem;
        }
        .status-success {
            background: #dcfce7;
            color: #166534;
        }
        .status-error {
            background: #fee2e2;
            color: #b91c1c;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            color: #4f46e5;
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 1rem;
            cursor: pointer;
        }
        .search-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #f3f4f6;
            border-radius: 14px;
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
        }
        .search-icon {
            font-size: 1.25rem;
            color: #6b7280;
        }
        .search-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 1rem;
            outline: none;
            color: #111827;
        }
        .store-suggestions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .store-card {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-radius: 16px;
            background: white;
            border: 1px solid #e5e7eb;
            box-shadow: 0 8px 24px rgba(79,70,229,0.08);
            align-items: center;
        }
        .store-meta {
            flex: 1;
        }
        .store-distance {
            font-weight: 600;
            color: #4f46e5;
        }
        .store-address {
            color: #6b7280;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }
        .store-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
        }
        .store-open {
            font-size: 0.8rem;
            font-weight: 600;
            color: #059669;
        }
        .store-open.closed {
            color: #b91c1c;
        }
        .store-btn {
            border: none;
            border-radius: 12px;
            padding: 0.5rem 0.85rem;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            font-size: 0.85rem;
        }
        .location-banner {
            background: #eef2ff;
            border: 1px dashed #a5b4fc;
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        .location-banner button {
            border: none;
            background: #4f46e5;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(17, 24, 39, 0.65);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            z-index: 2000;
        }
        .modal-card {
            background: #fff;
            border-radius: 20px;
            padding: 2rem 1.75rem;
            max-width: 420px;
            width: 100%;
            text-align: center;
            box-shadow: 0 25px 60px rgba(15, 23, 42, 0.35);
        }
        .modal-card h2 {
            margin-bottom: 0.75rem;
            color: #312e81;
            font-size: 1.5rem;
        }
        .modal-card p {
            color: #4b5563;
            margin-bottom: 1rem;
        }
        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1.25rem;
        }
        .modal-icon {
            font-size: 3rem;
            margin-bottom: 0.75rem;
        }
        .text-muted {
            font-size: 0.9rem;
            color: #6b7280;
        }
        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 1rem;
            text-align: center;
            position: relative;
        }
        .profile-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .user-info h2 { font-size: 1.3rem; margin-bottom: 0.25rem; }
        .user-info p { opacity: 0.9; font-size: 0.9rem; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            margin: 1rem;
            border-radius: 12px;
        }
        .stat-item {
            text-align: center;
            color: white;
        }
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }
        .content {
            padding: 1rem;
            padding-bottom: 6rem;
        }
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .action-btn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        .action-btn:hover {
            transform: translateY(-2px);
        }
        .action-icon {
            font-size: 1.5rem;
        }
        .section {
            margin-bottom: 2rem;
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 414px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            padding: 0.75rem 0;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            color: #6b7280;
            text-decoration: none;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .nav-item.active {
            color: #4f46e5;
        }
        .nav-icon {
            font-size: 1.25rem;
        }
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .transaction-item:last-child {
            border-bottom: none;
        }
        .transaction-info h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .transaction-info p {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .transaction-amount {
            font-weight: 600;
            color: #059669;
        }
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-paid { background: #d1fae5; color: #065f46; }
        .status-pending { background: #fef3c7; color: #92400e; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:8001'
            : window.location.origin;

        const Onboarding = ({ onComplete }) => {
            const [role, setRole] = useState(null);
            const [form, setForm] = useState({
                name: '',
                phone: '',
                shopName: ''
            });
            const [otp, setOtp] = useState('');
            const [otpSent, setOtpSent] = useState(false);
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState(null);

            const handleRoleSelect = (value) => {
                setRole(value);
                setStatus(null);
                setOtp('');
                setOtpSent(false);
            };

            const handleChange = (field, value) => {
                setForm(prev => ({ ...prev, [field]: value }));
            };

            const handleSendOtp = async () => {
                if (!form.phone) {
                    setStatus({ type: 'error', message: 'Please enter your phone number' });
                    return;
                }

                console.log('Sending OTP for phone:', form.phone);
                setLoading(true);
                setStatus(null);
                try {
                    console.log('Making API call to:', `${API_BASE}/auth/otp`);
                    const response = await axios.post(`${API_BASE}/auth/otp`, { phone: form.phone });
                    console.log('OTP API response:', response);
                    console.log('OTP sent successfully, setting otpSent to true');
                    setOtpSent(true);
                    setStatus({ type: 'success', message: 'OTP sent successfully' });
                } catch (error) {
                    console.log('Error sending OTP:', error);
                    console.log('Error response:', error?.response);
                    const detail = error?.response?.data?.message || error?.response?.data?.detail || 'Failed to send OTP. Please try again.';
                    setStatus({ type: 'error', message: detail });
                } finally {
                    console.log('Setting loading to false');
                    setLoading(false);
                }
            };

            const handleVerifyOtp = async () => {
                console.log('Verifying OTP:', otp, 'for phone:', form.phone);
                if (!otp) {
                    setStatus({ type: 'error', message: 'Enter the OTP you received' });
                    return;
                }

                setLoading(true);
                setStatus(null);
                try {
                    console.log('Making verify API call to:', `${API_BASE}/auth/verify`);
                    const response = await axios.post(`${API_BASE}/auth/verify`, {
                        phone: form.phone,
                        otp: otp
                    });
                    console.log('Verify API response:', response);
                    console.log('OTP verified successfully:', response.data);

                    setStatus({ type: 'success', message: 'OTP verified. Redirecting...' });
                    onComplete({
                        role,
                        name: form.name || `User ${form.phone.slice(-4)}`,
                        phone: form.phone,
                        shopName: form.shopName,
                        tokens: response.data
                    });
                } catch (error) {
                    console.log('Error verifying OTP:', error);
                    console.log('Error response:', error?.response);
                    const detail = error?.response?.data?.message || error?.response?.data?.detail || 'OTP verification failed';
                    setStatus({ type: 'error', message: detail });
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="onboarding-wrapper">
                    <div className="onboarding-card">
                        {role && (
                            <div className="back-link" onClick={() => handleRoleSelect(null)}>
                                ‚Üê Back
                            </div>
                        )}
                        <div className="onboarding-title">
                            <h1>Welcome to SCANEZY</h1>
                            <p>Select how you want to use the app</p>
                        </div>

                        {!role && (
                            <div className="role-grid">
                                <div
                                    className="role-card"
                                    onClick={() => handleRoleSelect('user')}
                                >
                                    <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>üõí</div>
                                    <h3>User</h3>
                                    <p style={{ fontSize: '0.85rem', color: '#6b7280' }}>Smart self-checkout shopping</p>
                                </div>
                                <div
                                    className="role-card"
                                    onClick={() => handleRoleSelect('shop')}
                                >
                                    <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>üè¨</div>
                                    <h3>Shop</h3>
                                    <p style={{ fontSize: '0.85rem', color: '#6b7280' }}>Manage store & realtime carts</p>
                                </div>
                            </div>
                        )}

                        {role && (
                            <div>
                                <h3 style={{ marginBottom: '1rem', color: '#111827' }}>
                                    {role === 'user' ? 'User Registration' : 'Shop Registration'}
                                </h3>
                                <div className="form-group">
                                    <label>{role === 'user' ? 'Full Name' : 'Owner Name'}</label>
                                    <input
                                        type="text"
                                        placeholder="Enter your name"
                                        value={form.name}
                                        onChange={(e) => handleChange('name', e.target.value)}
                                    />
                                </div>
                                {role === 'shop' && (
                                    <div className="form-group">
                                        <label>Shop Name</label>
                                        <input
                                            type="text"
                                            placeholder="SuperMart Downtown"
                                            value={form.shopName}
                                            onChange={(e) => handleChange('shopName', e.target.value)}
                                        />
                                    </div>
                                )}
                                <div className="form-group">
                                    <label>Phone Number</label>
                                    <input
                                        type="tel"
                                        placeholder="+91 98765 43210"
                                        value={form.phone}
                                        onChange={(e) => handleChange('phone', e.target.value)}
                                    />
                                </div>
                                <div className="otp-actions">
                                    <button className="secondary-btn" onClick={handleSendOtp} disabled={loading}>
                                        {otpSent ? 'Resend OTP' : 'Send OTP'}
                                    </button>
                                    <input
                                        type="text"
                                        placeholder="Enter OTP"
                                        style={{ flex: 1, padding: '0.75rem', borderRadius: '10px', border: '1px solid #c7d2fe' }}
                                        value={otp}
                                        onChange={(e) => setOtp(e.target.value)}
                                    />
                                </div>
                                <button
                                    className="primary-btn"
                                    style={{ marginTop: '1rem', width: '100%' }}
                                    onClick={handleVerifyOtp}
                                    disabled={loading || !otpSent}
                                >
                                    {loading ? 'Verifying...' : `Verify & Continue (loading: ${loading}, otpSent: ${otpSent})`}
                                </button>

                                {status && (
                                    <div className={`status-banner status-${status.type}`}>
                                        {status.message}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        function UserDashboard({ user }) {
            const [currentTab, setCurrentTab] = useState('dashboard');
            const [isAuthenticated, setIsAuthenticated] = useState(true);
            const [cameraGranted, setCameraGranted] = useState(() => localStorage.getItem('cameraPermission') === 'granted');
            const [cameraPromptVisible, setCameraPromptVisible] = useState(false);
            const [cameraStatus, setCameraStatus] = useState(null);
            const [locationGranted, setLocationGranted] = useState(() => localStorage.getItem('locationPermission') === 'granted');
            const [locationPromptVisible, setLocationPromptVisible] = useState(false);
            const [locationStatus, setLocationStatus] = useState(null);
            const [userLocation, setUserLocation] = useState(null);
            const [nearbyStores, setNearbyStores] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                // Attempt silent auth via persisted session if available in future
            }, []);

            useEffect(() => {
                if (isAuthenticated && !cameraGranted) {
                    setCameraPromptVisible(true);
                }
                if (isAuthenticated && !locationGranted) {
                    setLocationPromptVisible(true);
                }
            }, [isAuthenticated, cameraGranted]);

            useEffect(() => {
                if (locationGranted && userLocation == null) {
                    requestLocationAccess(true);
                }
            }, [locationGranted]);

            const requestCameraAccess = async () => {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    setCameraStatus({ type: 'error', message: 'Camera access is not supported on this device.' });
                    return;
                }

                try {
                    setCameraStatus(null);
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    stream.getTracks().forEach(track => track.stop());
                    localStorage.setItem('cameraPermission', 'granted');
                    setCameraGranted(true);
                    setCameraPromptVisible(false);
                    setCameraStatus({ type: 'success', message: 'Camera access granted. You can now scan QR and barcodes.' });
                } catch (error) {
                    setCameraStatus({ type: 'error', message: 'Camera permission denied. Please allow access to use the scanner.' });
                }
            };

            const buildSampleStores = (coords) => {
                const samples = [
                    { id: 'store-1', name: 'SuperMart Downtown', distance: 0.8, address: 'MG Road, Sector 14', open: true },
                    { id: 'store-2', name: 'Fresh Basket Organic', distance: 1.3, address: 'DLF Phase 2', open: true },
                    { id: 'store-3', name: 'Quick Cart Express', distance: 2.7, address: 'Cyber City', open: false }
                ];
                return samples.map(store => ({ ...store, distanceLabel: `${store.distance} km away` }));
            };

            const requestLocationAccess = (silent = false) => {
                if (!navigator.geolocation) {
                    setLocationStatus({ type: 'error', message: 'Location is not supported on this device.' });
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        localStorage.setItem('locationPermission', 'granted');
                        setLocationGranted(true);
                        setLocationPromptVisible(false);
                        setUserLocation({
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        });
                        setNearbyStores(buildSampleStores(position.coords));
                        if (!silent) {
                            setLocationStatus({ type: 'success', message: 'Location detected. Showing nearby stores.' });
                        }
                    },
                    (error) => {
                        const detail = error?.message || 'Location permission denied. Enable it to discover nearby stores.';
                        setLocationStatus({ type: 'error', message: detail });
                        setLocationPromptVisible(true);
                    },
                    { enableHighAccuracy: true, timeout: 8000 }
                );
            };

            const filteredStores = nearbyStores.filter(store =>
                store.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                store.address.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const CameraPermissionModal = () => (
                <div className="modal-overlay">
                    <div className="modal-card">
                        <div className="modal-icon">üì∑</div>
                        <h2>Enable Camera Access</h2>
                        <p>
                            SCANEZY needs your camera to scan QR codes and barcodes for instant checkout.
                            Please allow access to continue.
                        </p>
                        <div className="modal-actions">
                            <button className="primary-btn" onClick={requestCameraAccess}>Allow Camera Access</button>
                            <button className="secondary-btn" onClick={() => setCameraPromptVisible(false)}>Not Now</button>
                        </div>
                        <p className="text-muted">You can enable camera later from app settings.</p>
                    </div>
                </div>
            );

            const LocationPermissionModal = () => (
                <div className="modal-overlay">
                    <div className="modal-card">
                        <div className="modal-icon">üìç</div>
                        <h2>Enable Location</h2>
                        <p>
                            Turn on location to auto-suggest partner stores near you and provide walk-in directions.
                        </p>
                        <div className="modal-actions">
                            <button className="primary-btn" onClick={() => requestLocationAccess()}>Allow Location Access</button>
                            <button className="secondary-btn" onClick={() => setLocationPromptVisible(false)}>Maybe Later</button>
                        </div>
                        <p className="text-muted">We only use approximate location to show store suggestions.</p>
                    </div>
                </div>
            );

            const Dashboard = () => (
                <div>
                    <div className="header">
                        <div className="profile-section">
                            <div className="avatar">
                                {user.name.split(' ').map(n => n[0]).join('')}
                            </div>
                            <div className="user-info">
                                <h2>{user.name}</h2>
                                <p>{user.phone}</p>
                            </div>
                        </div>
                        
                        <div className="stats-grid">
                            <div className="stat-item">
                                <span className="stat-number">{user.totalOrders}</span>
                                <div className="stat-label">Total Orders</div>
                            </div>
                            <div className="stat-item">
                                <span className="stat-number">‚Çπ{user.totalSpent}</span>
                                <div className="stat-label">Total Spent</div>
                            </div>
                            <div className="stat-item">
                                <span className="stat-number">‚Çπ{user.savedAmount}</span>
                                <div className="stat-label">Saved</div>
                            </div>
                        </div>
                    </div>

                    <div className="content">
                        {!locationGranted && (
                            <div className="location-banner">
                                <div style={{fontSize: '1.5rem'}}>üìç</div>
                                <div style={{flex: 1}}>
                                    <strong>Enable location for hyper-local stores</strong>
                                    <p style={{color: '#6b7280', fontSize: '0.85rem'}}>Turn on GPS to automatically fetch partner stores and queue availability.</p>
                                </div>
                                <button onClick={() => requestLocationAccess()}>Enable</button>
                            </div>
                        )}

                        <div className="search-container">
                            <div className="search-icon">üîé</div>
                            <input
                                className="search-input"
                                placeholder="Search for items, stores, or locations"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>

                        <div className="quick-actions">
                            <button className="action-btn" onClick={() => setCurrentTab('scan')}>
                                <div className="action-icon">üì±</div>
                                <div>Start Shopping</div>
                            </button>
                            <button className="action-btn" onClick={() => setCurrentTab('cart')}>
                                <div className="action-icon">üõí</div>
                                <div>View Cart</div>
                            </button>
                        </div>

                        <div className="section">
                            <div className="section-title">üè¨ Nearby Stores</div>
                            {locationGranted && filteredStores.length === 0 && (
                                <p style={{color: '#6b7280'}}>No stores match your search. Try a different keyword.</p>
                            )}
                            {!locationGranted && (
                                <p style={{color: '#6b7280'}}>Turn on location to see curated store suggestions in your city.</p>
                            )}
                            {locationGranted && filteredStores.length > 0 && (
                                <div className="store-suggestions">
                                    {filteredStores.map(store => (
                                        <div key={store.id} className="store-card">
                                            <div className="store-meta">
                                                <h4 style={{marginBottom: '0.25rem'}}>{store.name}</h4>
                                                <div className="store-address">{store.address}</div>
                                            </div>
                                            <div className="store-actions">
                                                <div className="store-distance">{store.distanceLabel}</div>
                                                <div className={`store-open ${store.open ? '' : 'closed'}`}>
                                                    {store.open ? 'Open Now' : 'Closed'}
                                                </div>
                                                <button className="store-btn">View Queue</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        <div className="section">
                            <div className="section-title">
                                üéâ Special Offers
                            </div>
                            <div className="card" style={{background: 'linear-gradient(135deg, #fef3c7, #fde68a)', border: '1px solid #f59e0b'}}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                    <div style={{flex: 1}}>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem'}}>
                                            <h4 style={{color: '#92400e'}}>Flash Sale 30% Off</h4>
                                            <span style={{background: '#dc2626', color: 'white', padding: '0.25rem 0.5rem', borderRadius: '12px', fontSize: '0.7rem', fontWeight: 'bold'}}>
                                                30% OFF
                                            </span>
                                        </div>
                                        <p style={{color: '#a16207', fontSize: '0.9rem', marginBottom: '0.5rem'}}>Limited time offer on selected items</p>
                                        <p style={{color: '#78716c', fontSize: '0.8rem'}}>
                                            <strong>SuperMart Downtown</strong> ‚Ä¢ Valid until Nov 25, 2024
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="section">
                            <div className="section-title">
                                üìä Recent Transactions
                            </div>
                            <div className="card">
                                {transactions.slice(0, 3).map(transaction => (
                                    <div key={transaction.id} className="transaction-item">
                                        <div className="transaction-info">
                                            <h4>{transaction.store}</h4>
                                            <p>{transaction.date} ‚Ä¢ {transaction.items} items</p>
                                        </div>
                                        <div style={{textAlign: 'right'}}>
                                            <div className="transaction-amount">‚Çπ{transaction.amount}</div>
                                            <span className={`status-badge status-${transaction.status}`}>
                                                {transaction.status}
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );

            const Scanner = () => (
                <div>
                    <div className="header">
                        <h2>Barcode Scanner</h2>
                        <p>Scan products to add to cart</p>
                    </div>
                    
                    <div className="content">
                        <div className="card" style={{textAlign: 'center', padding: '3rem 1rem'}}>
                            <div style={{fontSize: '4rem', marginBottom: '1rem'}}>üì∑</div>
                            <h3>Point camera at barcode</h3>
                            <p style={{color: '#6b7280', marginTop: '0.5rem'}}>
                                Position the barcode within the frame to scan
                            </p>
                        </div>
                    </div>
                </div>
            );

            const Cart = () => (
                <div>
                    <div className="header">
                        <h2>Shopping Cart</h2>
                        <p>0 items</p>
                    </div>
                    
                    <div className="content">
                        <div className="card" style={{textAlign: 'center', padding: '3rem 1rem'}}>
                            <div style={{fontSize: '4rem', marginBottom: '1rem'}}>üõí</div>
                            <h3>Your cart is empty</h3>
                            <p style={{color: '#6b7280', marginTop: '0.5rem'}}>
                                Start shopping to add items to your cart
                            </p>
                        </div>
                    </div>
                </div>
            );

            const Transactions = () => (
                <div>
                    <div className="header">
                        <h2>Transaction History</h2>
                        <p>{transactions.length} transactions</p>
                    </div>
                    
                    <div className="content">
                        <div className="card">
                            {transactions.map(transaction => (
                                <div key={transaction.id} className="transaction-item">
                                    <div className="transaction-info">
                                        <h4>{transaction.store}</h4>
                                        <p>{transaction.date} ‚Ä¢ {transaction.items} items</p>
                                    </div>
                                    <div style={{textAlign: 'right'}}>
                                        <div className="transaction-amount">‚Çπ{transaction.amount}</div>
                                        <span className={`status-badge status-${transaction.status}`}>
                                            {transaction.status}
                                        </span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            const Profile = () => (
                <div>
                    <div className="header">
                        <h2>Profile Settings</h2>
                        <p>Manage your account</p>
                    </div>
                    
                    <div className="content">
                        <div className="section">
                            <div className="section-title">üë§ Personal Information</div>
                            <div className="card">
                                <div style={{marginBottom: '1rem'}}>
                                    <label style={{display: 'block', marginBottom: '0.5rem', fontWeight: '500'}}>Name</label>
                                    <input type="text" value={user.name} style={{width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '6px'}} readOnly />
                                </div>
                                <div style={{marginBottom: '1rem'}}>
                                    <label style={{display: 'block', marginBottom: '0.5rem', fontWeight: '500'}}>Phone</label>
                                    <input type="text" value={user.phone} style={{width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '6px'}} readOnly />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="mobile-container">
                    {currentTab === 'dashboard' && <Dashboard />}
                    {currentTab === 'scan' && <Scanner />}
                    {currentTab === 'cart' && <Cart />}
                    {currentTab === 'transactions' && <Transactions />}
                    {currentTab === 'profile' && <Profile />}
                    
                    <div className="bottom-nav">
                        <a href="#" className={`nav-item ${currentTab === 'dashboard' ? 'active' : ''}`}
                           onClick={(e) => { e.preventDefault(); setCurrentTab('dashboard'); }}>
                            <div className="nav-icon">üè†</div>
                            <div>Home</div>
                        </a>
                        <a href="#" className={`nav-item ${currentTab === 'scan' ? 'active' : ''}`}
                           onClick={(e) => { e.preventDefault(); setCurrentTab('scan'); }}>
                            <div className="nav-icon">üì±</div>
                            <div>Scan</div>
                        </a>
                        <a href="#" className={`nav-item ${currentTab === 'cart' ? 'active' : ''}`}
                           onClick={(e) => { e.preventDefault(); setCurrentTab('cart'); }}>
                            <div className="nav-icon">üõí</div>
                            <div>Cart</div>
                        </a>
                        <a href="#" className={`nav-item ${currentTab === 'transactions' ? 'active' : ''}`}
                           onClick={(e) => { e.preventDefault(); setCurrentTab('transactions'); }}>
                            <div className="nav-icon">üìä</div>
                            <div>History</div>
                        </a>
                        <a href="#" className={`nav-item ${currentTab === 'profile' ? 'active' : ''}`}
                           onClick={(e) => { e.preventDefault(); setCurrentTab('profile'); }}>
                            <div className="nav-icon">üë§</div>
                            <div>Profile</div>
                        </a>
                    </div>

                    {cameraPromptVisible && <CameraPermissionModal />}
                    {locationPromptVisible && <LocationPermissionModal />}
                    {cameraStatus && cameraStatus.type === 'error' && (
                        <div className="status-banner status-error" style={{ position: 'fixed', bottom: '5rem', left: '50%', transform: 'translateX(-50%)', maxWidth: '414px' }}>
                            {cameraStatus.message}
                        </div>
                    )}
                    {cameraStatus && cameraStatus.type === 'success' && (
                        <div className="status-banner status-success" style={{ position: 'fixed', bottom: '5rem', left: '50%', transform: 'translateX(-50%)', maxWidth: '414px' }}>
                            {cameraStatus.message}
                        </div>
                    )}
                    {locationStatus && (
                        <div className={`status-banner status-${locationStatus.type}`} style={{ position: 'fixed', bottom: '8.5rem', left: '50%', transform: 'translateX(-50%)', maxWidth: '414px' }}>
                            {locationStatus.message}
                        </div>
                    )}
                </div>
            );
        }

        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (event) => {
            event.preventDefault();
            deferredPrompt = event;
            const installButton = document.createElement('button');
            installButton.textContent = 'üì± Install App';
            installButton.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4f46e5, #7c3aed);
                color: white;
                border: none;
                padding: 0.75rem 1rem;
                border-radius: 12px;
                font-weight: 600;
                cursor: pointer;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            installButton.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                        installButton.remove();
                    }
                    deferredPrompt = null;
                });
            });
            
            document.body.appendChild(installButton);
        });

        // Handle app installation
        window.addEventListener('appinstalled', (evt) => {
            console.log('SCANEZY app was installed.');
        });

        // Error Boundary Component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error('Error caught by boundary:', error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div style={{ padding: '2rem', color: 'white', textAlign: 'center' }}>
                            <h2>Something went wrong</h2>
                            <p>Please refresh the page or try again later.</p>
                            <button 
                                onClick={() => window.location.reload()}
                                style={{
                                    background: 'white',
                                    color: '#4f46e5',
                                    border: 'none',
                                    padding: '0.5rem 1rem',
                                    borderRadius: '8px',
                                    marginTop: '1rem',
                                    cursor: 'pointer'
                                }}
                            >
                                Refresh Page
                            </button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // Main App Component
        function App() {
            const [isOnboarded, setIsOnboarded] = useState(() => {
                return localStorage.getItem('onboarded') === 'true';
            });

            const [user, setUser] = useState(null);

            const handleOnboardingComplete = (profile) => {
                console.log('App onboarding complete with profile:', profile);
                setUser(profile);
                localStorage.setItem('onboarded', 'true');
                setIsOnboarded(true);
            };

            return (
                <ErrorBoundary>
                    {isOnboarded ? (
                        <UserDashboard user={user} />
                    ) : (
                        <Onboarding onComplete={handleOnboardingComplete} />
                    )}
                </ErrorBoundary>
            );
        }

        // Mount the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <React.StrictMode>
                <App />
            </React.StrictMode>
        );
    </script>
</body>
</html>
